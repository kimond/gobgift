{% extends "gobgift/_layout.html" %}
{% load backend_utils %}
{% block content %}
    <div class="mdl-grid">
        <div class="mdl-cell mdl-cell--3-col"></div>
                <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--6-col">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Welcome <i>{{ user.username }}</i>!</h2>
                    </div>
                    <div class="mdl-card__supporting-text ">
                        <ul>
                            <li><a class="btn btn-success" href="/listes/"> Voir les listes </a></li>
                            <li><a class="btn btn-success" href="/listes/add/">Cr√©er votre liste</a></li>
                        </ul>
                        {% for sublist in available_backends|social_backends %}
                        <div class="row">
                            {% for name, backend in sublist %}
                            {% associated backend %}
                            {% if association %}
                            <form class="disconnect-form col md2" action="{% url "social:disconnect_individual" backend=association.provider association_id=association.id %}" method="post">{% csrf_token %}
                                <a class="btn btn-danger" name="{{ backend|backend_class }}" href="#">
                                    <i class="fa fa-{{ name|icon_name }}"></i>
                                    Disconnect {{ backend|backend_name }}
                                </a>
                            </form>
                            {% else %}
                            <a class="col md2 btn btn-default" name="{{ backend|backend_class }}" href="{% url "social:begin" backend=name %}">
                                <i class="fa fa-{{ name|icon_name }}"></i>
                                {{ backend|backend_name }}
                            </a>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" href="/media/gobgift.apk">Download Android version 0.1</a> 
                    </div>
                </div>

    {% if backend %}
      <div id="email-required-modal" class="modal fade">
        <form action="{% url "social:complete" backend=backend %}" method="post" role="form">{% csrf_token %}
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Email required</h4>
              </div>

              <div class="modal-body">
                <p>An email address is required.</p>
                <div class="form-group">
                  <label class="control-label" for="email">Email address:</label>
                  <input class="form-control" id="email" type="email" name="email" value="" />
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Continue</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    {% endif %}

    {# <div id="validation-sent-modal" class="modal fade"> #}
    {#   <div class="modal-dialog"> #}
    {#     <div class="modal-content"> #}
    {#       <div class="modal-header"> #}
    {#         <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button> #}
    {#         <h4 class="modal-title">Email Validation Sent</h4> #}
    {#       </div> #}
    {#  #}
    {#       <div class="modal-body"> #}
    {#         <p>An email validation was sent{% if email %} to <code>{{ email }}</code>{% endif %}.</p> #}
    {#         <p>Click the link sent to finish the authentication process.</p> #}
    {#       </div> #}
    {#  #}
    {#       <div class="modal-footer"> #}
    {#         <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> #}
    {#       </div> #}
    {#     </div> #}
    {#   </div> #}
    {# </div> #}

    <script type="text/javascript">
      var signInCallback = function (result) {
          if (result['error']) {
            alert('An error happened:', result['error']);
          } else {
            $('#code').attr('value', result['code']);
            $('#at').attr('value', result['access_token']);
            $('#google-plus').submit();
          }
      };

      var modalDialog = function (modalId, modalLinkName, submitHandler) {
        var $modal;

        $modal = $(modalId).modal({show: false});

        $modal.on('click', '.btn-primary', submitHandler || function (event) {
          event.preventDefault();
          $modal.find('form').submit();
        });

        if (modalLinkName) {
          $('a[name="' + modalLinkName + '"]').on('click', function (event) {
            event.preventDefault();
            $modal.modal('toggle');
          });
        }

        return $modal;
      };

      $(function () {
        var $validationModal, $emailRequired;

        modalDialog('#livejournal-modal', 'livejournal');
        modalDialog('#openid-modal', 'openid');
        modalDialog('#email-modal', 'email');
        modalDialog('#username-modal', 'username');
        $validationModal = modalDialog('#validation-sent-modal');
        $emailRequired = modalDialog('#email-required-modal');

        modalDialog('#ajax-login-modal', 'ajax-login', function (event) {
          var $backend, $accessToken, $accessTokenSecret, $fields, $result;
          event.preventDefault();

          $modal = $(this).closest('.modal');
          $form = $modal.find('form');
          $backend = $modal.find('[name="backend"]');
          $accessToken = $modal.find('[name="access_token"]');
          $accessTokenSecret = $modal.find('[name="access_token_secret"]');
          $result = $modal.find('.login-result');

          $.get('/ajax-auth/' + $backend.val() + '/', {
            access_token: $accessToken.val(),
            access_token_secret: $accessTokenSecret.val(),
          }, function (data, xhr, response) {
            $result.find('.user-id').html(data.id);
            $result.find('.user-username').html(data.username);
            $form.hide();
            $result.show();
            setTimeout(function () { window.location = '/'; }, 10000);
          }, 'json')
        });

        $('.disconnect-form').on('click', 'a.btn', function (event) {
          event.preventDefault();
          $(event.target).closest('form').submit();
        });

        {% if validation_sent %}
          $validationModal.modal('show');
        {% endif %}

        {% if email_required %}
          $emailRequired.modal('show');
        {% endif %}
      });
    </script>
{% endblock %}
